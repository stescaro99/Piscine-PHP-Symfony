{% extends 'base.html.twig' %}

{% block title %}{{ project.name }}{% endblock %}

{% block body %}
<div class="edit_info">
    <h1>{{ project.name }}</h1>

    <p><strong>Description:</strong> {{ project.description }}</p>
    <p><strong>XP:</strong> {{ project.xp }}</p>
    <p><strong>Estimated Time:</strong> {{ project.estimatedTimeInHours }} hours</p>

    {% set registeredParticipants = project.getUserProjects()|filter(up => not up.validated) %}
    {% set completedParticipants = project.getUserProjects()|filter(up => up.validated) %}

    <p><strong>Registered Participants:</strong> {{ registeredParticipants|length }}</p>
    <p><strong>Completed</strong> {{ completedParticipants|length }} times <strong>so far.</strong></p>

    {% if app.user %}
        {% if userProject is defined and userProject %}
            {% if not userProject.validated %}
                <form action="{{ path('project_unregister', { id: project.id }) }}" method="post">
                    <button class="btn btn-primary" type="submit">Unregister</button>
                </form>

                <form action="{{ path('chat_project', { projectId: project.id }) }}" method="get">
                    <button class="btn btn-primary" type="submit">üí¨ Chat Progetto</button>
                </form>

                {% if not userProject.uploadedFilePath %}
                    <h3>Upload your project file</h3>
                    {% if app.user.evalPoints >= 1 %}
                        <form action="{{ path('project_upload', { id: project.id }) }}" method="post" enctype="multipart/form-data">
                            <input type="file" name="project_file" required />
                            <br>
                            <label for="bonus_file">Bonus file (optional):</label>
                            <input type="file" name="bonus_file" />
                            <br>
                            <button type="submit">Submit for Evaluation</button>
                        </form>
                    {% else %}
                        <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <strong>‚ö†Ô∏è Insufficient Evaluation Points</strong><br>
                            You need at least 1 evaluation point to submit a project for evaluation.<br>
                            <small>Current evaluation points: {{ app.user.evalPoints }}</small>
                        </div>
                    {% endif %}
                {% else %}
                    <p><strong>‚úÖ Project submitted for evaluation</strong></p>
                    <p>Uploaded file: <a href="{{ asset('uploads/project_files/' ~ userProject.uploadedFilePath) }}" target="_blank">Download</a></p>
                    
                    {% if evaluationRequest and not evaluationRequest.evaluator %}
                        <h3>Select an Evaluator</h3>
                        <p>Choose an available evaluation slot:</p>
                        
                        {% if availableSlots|length > 0 %}
                            <div style="margin: 1rem 0;">
                                {% for slot in availableSlots %}
                                    <div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 5px;">
                                        <strong>{{ slot.userId.firstName }} {{ slot.userId.lastName }}</strong><br>
                                        <small>{{ slot.startTime|date('Y-m-d H:i') }} - {{ slot.endTime|date('H:i') }}</small><br>
                                        <form action="{{ path('project_select_evaluator', { id: project.id, slotId: slot.id }) }}" method="post" style="margin-top: 5px;">
                                            <button type="submit" class="btn btn-primary btn-sm">Select this Evaluator</button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p><em>No evaluation slots available at the moment. Please check back later.</em></p>
                        {% endif %}
                    {% elseif evaluationRequest and evaluationRequest.evaluator %}
                        <p><strong>üîç Under evaluation by:</strong> {{ evaluationRequest.evaluator.firstName }} {{ evaluationRequest.evaluator.lastName }}</p>
                        
                        {% if evaluationRequest.validated %}
                            <p><strong>‚úÖ Evaluation completed!</strong></p>
                        {% else %}
                            <p><em>Waiting for evaluation to be completed...</em></p>
                        {% endif %}
                    {% endif %}
                {% endif %}
                
            {% else %}
                <p><strong>Project completed ‚úÖ</strong></p>
                {% if userProject.uploadedFilePath %}
                    <p>Uploaded file: <a href="{{ asset('uploads/project_files/' ~ userProject.uploadedFilePath) }}" target="_blank">Download</a></p>
                {% endif %}
                {% if userProject.validatedBy %}
                    <p><strong>Validated by:</strong> {{ userProject.validatedBy.firstName }} {{ userProject.validatedBy.lastName }}</p>
                {% endif %}
            {% endif %}
        {% else %}
        
            <form action="{{ path('project_register', { id: project.id }) }}" method="post">
                <button class="btn btn-primary" type="submit">Register</button>
            </form>
        {% endif %}
    {% else %}
        <p><a href="{{ path('login') }}">Login</a> to register for this project.</p>
    {% endif %}

    <form action="{{ path('project_list') }}" method="get">
        <button class="btn btn-primary" type="submit">Back to list</button>
    </form>
</div>
{% endblock %}
