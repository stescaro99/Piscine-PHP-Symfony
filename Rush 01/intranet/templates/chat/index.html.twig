{% extends 'base.html.twig' %}

{% block title %} {{parent()}} | Chat{% endblock %}


{% block stylesheets %}
    {{parent()}}
    <link rel="stylesheet" href="{{ asset('css/chat-main.css') }}">
{% endblock %}

{% block body %}

{% include 'components/navbar.html.twig' %}

<div class="chat-container">
    <div class="chat-sidebar">
        <h3>Chat</h3>
        <div class="chat-tabs">
            <button class="tab-btn active" data-tab="conversations">Conversations</button>
            <button class="tab-btn" data-tab="users">Users</button>
        </div>
        
        <div id="conversations-tab" class="tab-content active">
            <div class="conversations-list">
                {% if conversations is empty %}
                    <div class="no-conversations">
                        <p>No conversations yet</p>
                        <small>Start chatting with users to see conversations here</small>
                    </div>
                {% else %}
                    {% for conversation in conversations %}
                        <button class="btn btn-secondary {% if conversation.unread_count > 0 %}unread{% endif %}" 
                                data-type="private" 
                                data-id="{{ conversation.recipient_id }}"
                                data-name="{{ conversation.name }}"
                                onclick="openChat('{{ conversation.recipient_id }}', '{{ conversation.name }}');">
                            <div class="conversation-info">
                                <div class="conversation-header">
                                    <span class="conversation-name">{{ conversation.name }}</span>
                                    <div class="conversation-meta">
                                        <span class="conversation-time">{{ conversation.last_message_time|date('H:i') }}</span>
                                        {% if conversation.unread_count > 0 %}
                                            <span class="unread-badge">{{ conversation.unread_count }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="conversation-preview">
                                    <div class="conversation-last-message">{{ conversation.last_message ?: 'No messages yet' }}</div>
                                </div>
                            </div>
                        </button>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        
        <div id="users-tab" class="tab-content">
            <div class="users-search">
                <input type="text" id="user-search" placeholder="Find users...">
                <div id="users-list" class="users-list">
                </div>
            </div>
        </div>
    </div>
    
    <div class="chat-main">
        <div id="chat-header" class="chat-header">
            <span>Select a conversation</span>
        </div>
        
        <div id="chat-messages" class="chat-messages">
            <div class="no-chat-selected">
                <p>Select a user or a conversation to start chatting</p>
            </div>
        </div>
        
        <div id="chat-input-container" class="chat-input" style="display: none;">
            <form id="chat-form" enctype="multipart/form-data">
                <div class="input-group">
                    <input type="text" id="message-input" placeholder="Type a message..." maxlength="1000">
                    <input type="file" id="media-input" accept="image/*,video/*,audio/*,.pdf,.doc,.docx" style="display: none;">
                    <button type="button" id="media-btn" class="media-btn" title="Attach file">ðŸ“Ž</button>
                    <button type="submit">Send</button>
                </div>
                <div id="file-preview" class="file-preview" style="display: none;"></div>
            </form>
        </div>
    </div>
</div>

<script>
    window.chatConfig = {
        currentUserId: {{ app.user.id }}
    };
    
    window.openChat = function(recipientId, recipientName) {
        console.log('openChat (template version) called with:', recipientId, recipientName);
        
        function waitForMainChat(attempts = 0) {
            if (window.mainChatInstance && window.mainChatInstance.startPrivateChat) {
                console.log('MainChat instance found, starting private chat');
                try {
                    window.mainChatInstance.startPrivateChat(recipientId);
                } catch (error) {
                    console.error('Error starting private chat:', error);
                }
            } else if (attempts < 30) {
                console.log('Waiting for MainChat instance... attempt', attempts + 1);
                setTimeout(() => waitForMainChat(attempts + 1), 100);
            } else {
                console.error('MainChat instance not found after 3 seconds');
                alert('Chat system not ready yet. Please reload the page and try again.');
            }
        }
        
        waitForMainChat();
    };
    
    if (typeof openChat !== 'function') {
        window.openChat = window.openChat;
    }
    
    console.log('openChat function available:', typeof window.openChat === 'function');
</script>
<script src="{{ asset('js/chat-main.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('After script load - openChat function available:', typeof window.openChat === 'function');
        console.log('MainChat instance available:', typeof window.mainChatInstance !== 'undefined');
    });
</script>
{% endblock %}
